<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sanscar · Blog</title>

    <!-- External libs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-xh6O/CkQoMX2P+6VhtAKz8WbRHFqRSbVSSMzdg3NofM8JrIoVNewc19hXtOD87bwo4V/mQJu1jLK5j1Xy8o1ig==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha512-SrG1CEV4VpWwfvX2gYdEx+kt1/3uzMdGII4XESyqSeX5TR1+t0NenE2no0RvrRZtGJPD7WvyaManIeZDV4SS2w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css" integrity="sha512-w1BTtPlqvGjufH6G+j6lJzi10BGi7ipo+nWQBaIj++ImQxGc1dQc5sKXc5teLoI0lp4rWuHwoMvVJE9idh+NRA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js" integrity="sha512-xeJ2J0PkD3YzUzqV+0Gooy2cuglRez2oJ6TP2PzefDs2fzGEylh4G6dkprdFMn/hTyBC0bYKT1eZq9VHtV6feg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js" integrity="sha512-xWxppIqhzyapMI2vlA38nSxrdbidKdvUSsfx8bVsgcuyo6edSxnl2xe50Tzw9uQWGWpZJYG1ChcxrFA8bUkOaw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js" integrity="sha512-dEaCPGK/c/pX9nuSUXwxuEcg2YkdE+5EYXPLkZX31lrT7xvFeoJEB6Digw1VE3DybMT0SqnX+ANXoy2cugl+cQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-I8CbnMD4HzyBbs6k8ZZrVSu2Ce279b9Ec/WWEDuJeayQMZT6X0hgqP/d9vywgq6Z9eruqbWtaXDpUe1koXSPew==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js" integrity="sha512-8TQSuHU1zszbmWzxubUANe0yoyS9MhUlCT3VkOITkkpFmS6r30YIOCwRvDDDeWGPAHDLcGRIDcH+xr3aMcMBqQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        :root {
            --bg: #f5f2ed;
            --card: #ffffff;
            --text: #1e2a32;
            --muted: #6d7582;
            --accent: #0a84ff;
            --border: rgba(9, 30, 66, 0.08);
            --radius: 18px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 32px clamp(16px, 4vw, 64px);
        }

        .site-shell {
            max-width: 1100px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 32px;
        }

        header h1 {
            font-size: clamp(2rem, 3vw, 2.75rem);
            margin: 0;
        }

        header p {
            margin: 8px 0 0;
            color: var(--muted);
        }

        .actions {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .actions input {
            flex: 1;
            min-width: 220px;
            padding: 10px 16px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--card);
            font-size: 0.95rem;
        }

        .status-chip {
            padding: 10px 16px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--card);
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--muted);
        }

        #posts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .post-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 30px 60px rgba(10, 52, 89, 0.08);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .post-heading {
            margin-bottom: 20px;
        }

        .post-heading h2 {
            font-size: 1.25rem;
            margin: 0 0 6px;
            line-height: 1.3;
        }

        .post-heading time {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .post-body {
            flex: 1;
            overflow: hidden;
        }

        .post-body.collapsed {
            max-height: 260px;
            position: relative;
        }

        .post-body.collapsed::after {
            content: "";
            position: absolute;
            inset: auto 0 0 0;
            height: 80px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0), var(--card));
        }

        .post-body p {
            margin: 0 0 1rem;
            line-height: 1.6;
        }

        .post-body img {
            max-width: 100%;
            border-radius: 12px;
        }

        .post-body pre {
            background: #0d1117;
            color: #f0f6fc;
            padding: 16px;
            border-radius: 12px;
            overflow-x: auto;
        }

        .post-body code {
            font-family: "JetBrains Mono", "SFMono-Regular", Consolas, monospace;
        }

        .post-footer {
            margin-top: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .btn {
            border: none;
            border-radius: 999px;
            padding: 10px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn.primary {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 10px 20px rgba(10, 132, 255, 0.25);
        }

        .btn.secondary {
            background: rgba(10, 132, 255, 0.08);
            color: var(--accent);
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .empty-state,
        .error-state {
            border-radius: var(--radius);
            padding: 32px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            border: 1px dashed var(--border);
            margin-top: 40px;
            color: var(--muted);
        }

        .skeleton {
            animation: pulse 1.5s infinite ease-in-out;
            background: linear-gradient(90deg, #f1f1f1 25%, #f8f8f8 37%, #f1f1f1 63%);
            background-size: 400% 100%;
        }

        .skeleton.card {
            height: 260px;
            border-radius: var(--radius);
        }

        @keyframes pulse {
            0% {
                background-position: 100% 0;
            }
            100% {
                background-position: -100% 0;
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 24px 16px;
            }
            .post-body.collapsed {
                max-height: 220px;
            }
        }
    </style>
</head>
<body>
    <div class="site-shell">
        <header>
            <h1></h1>Notebook · sanscar</h1>
            <p>Notes on models, math, and interpretability. Rendered straight from markdown with KaTeX + syntax highlighting.</p>
            <div class="actions">
                <input id="search" type="search" placeholder="Search by title or content…" />
                <span class="status-chip" id="status-chip">
                    <i class="fa-solid fa-circle-notch fa-spin" aria-hidden="true"></i>
                    Loading posts…
                </span>
            </div>
        </header>

        <section id="posts-grid" aria-live="polite">
            <div class="post-card skeleton card"></div>
            <div class="post-card skeleton card"></div>
            <div class="post-card skeleton card"></div>
        </section>

        <div class="empty-state" id="empty-state" hidden>
            <i class="fa-regular fa-folder-open fa-2x" aria-hidden="true"></i>
            <p>No posts match that search.</p>
        </div>

        <div class="error-state" id="error-state" hidden>
            <strong>Something went wrong while loading the blog.</strong>
            <p id="error-message"></p>
        </div>
    </div>

    <script>
        const grid = document.getElementById("posts-grid");
        const statusChip = document.getElementById("status-chip");
        const emptyState = document.getElementById("empty-state");
        const errorState = document.getElementById("error-state");
        const errorMessage = document.getElementById("error-message");
        const searchInput = document.getElementById("search");

        let cachedPosts = [];

        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: true,
            mangle: false,
            highlight(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        function updateStatus(text, iconClass = "fa-circle-notch fa-spin") {
            statusChip.innerHTML = `<i class="fa-solid ${iconClass}" aria-hidden="true"></i>${text}`;
        }

        function clearSkeletons() {
            grid.innerHTML = "";
        }

        function createPostCard(post) {
            const article = document.createElement("article");
            article.className = "post-card";
            article.innerHTML = `
                <div class="post-heading">
                    <h2>${post.title}</h2>
                    <time datetime="${post.date}">${new Date(post.date).toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" })}</time>
                </div>
                <div class="post-body collapsed">${post.html}</div>
                <div class="post-footer">
                    <button class="btn primary" type="button">Expand</button>
                    <span class="status-chip" aria-live="polite">
                        <i class="fa-solid fa-code" aria-hidden="true"></i>
                        markdown · math ready
                    </span>
                </div>
            `;

            const body = article.querySelector(".post-body");
            const toggleBtn = article.querySelector(".btn.primary");

            toggleBtn.addEventListener("click", () => {
                const isCollapsed = body.classList.toggle("collapsed");
                toggleBtn.textContent = isCollapsed ? "Expand" : "Collapse";
            });

            article.querySelectorAll("pre code").forEach(block => {
                hljs.highlightElement(block);
            });

            renderMathInElement(article, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false }
                ],
                throwOnError: false
            });

            return article;
        }

        function renderPosts(posts) {
            clearSkeletons();
            emptyState.hidden = posts.length !== 0;

            if (!posts.length) {
                return;
            }

            const fragment = document.createDocumentFragment();
            posts.forEach(post => fragment.appendChild(createPostCard(post)));
            grid.appendChild(fragment);
        }

        function applySearch() {
            const query = searchInput.value.trim().toLowerCase();
            if (!query) {
                renderPosts(cachedPosts);
                return;
            }

            const filtered = cachedPosts.filter(p =>
                p.title.toLowerCase().includes(query) ||
                p.raw.toLowerCase().includes(query)
            );
            renderPosts(filtered);
        }

        async function fetchMarkdown(file) {
            const res = await fetch(file);
            if (!res.ok) throw new Error(`Failed to fetch ${file} (${res.status})`);
            return res.text();
        }

        async function loadPosts() {
            updateStatus("Loading posts…");

            try {
                const listResponse = await fetch("blog.json");
                if (!listResponse.ok) {
                    throw new Error(`Unable to load blog.json (${listResponse.status})`);
                }

                const entries = await listResponse.json();
                if (!Array.isArray(entries) || entries.length === 0) {
                    throw new Error("No posts found in blog.json");
                }

                const hydrated = await Promise.all(
                    entries.map(async meta => {
                        const raw = await fetchMarkdown(meta.file);
                        const html = DOMPurify.sanitize(marked.parse(raw));
                        return { ...meta, html, raw };
                    })
                );

                cachedPosts = hydrated;
                renderPosts(hydrated);
                updateStatus(`Loaded ${hydrated.length} posts`, "fa-book-open");
            } catch (err) {
                console.error(err);
                errorMessage.textContent = err.message;
                errorState.hidden = false;
                updateStatus("Load failed", "fa-triangle-exclamation");
                clearSkeletons();
            }
        }

        searchInput.addEventListener("input", () => {
            window.requestAnimationFrame(applySearch);
        });

        loadPosts();
    </script>
</body>
</html>
